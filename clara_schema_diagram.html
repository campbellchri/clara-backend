<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clara MVP - Database Schema</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 40px;
            color: #e0e0e0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d4aa, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }
        .diagram-container {
            background: #ffffff;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            margin-bottom: 40px;
        }
        .mermaid {
            display: flex;
            justify-content: center;
        }
        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }
        .legend-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
        }
        .legend-card h3 {
            color: #00d4aa;
            margin-bottom: 12px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-card h3::before {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #00d4aa;
            border-radius: 3px;
        }
        .legend-card ul {
            list-style: none;
            font-size: 0.9rem;
            color: #aaa;
        }
        .legend-card li {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .legend-card li:last-child {
            border-bottom: none;
        }
        .key-badge {
            display: inline-block;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
            font-weight: 600;
        }
        .pk { background: #7c3aed; color: white; }
        .fk { background: #0ea5e9; color: white; }
        .idx { background: #f59e0b; color: white; }
        .relationships {
            margin-top: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .relationships h2 {
            color: #7c3aed;
            margin-bottom: 20px;
        }
        .rel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .rel-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .rel-item code {
            color: #00d4aa;
            font-weight: 600;
        }
        .notes {
            margin-top: 40px;
            background: rgba(124, 58, 237, 0.1);
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 12px;
            padding: 25px;
        }
        .notes h2 {
            color: #a78bfa;
            margin-bottom: 15px;
        }
        .notes ul {
            margin-left: 20px;
            color: #ccc;
        }
        .notes li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Clara MVP Database Schema</h1>
        <p class="subtitle">Healthcare Claims Preparation System - Simplified ERD</p>
        
        <div class="diagram-container">
            <div class="mermaid">
erDiagram
    Practice {
        uuid id PK
        string name
        string npi
        string tax_id
        string address
        timestamp created_at
    }

    Therapist {
        uuid id PK
        uuid practice_id FK
        string first_name
        string last_name
        string npi
        string license_number
        boolean is_active
    }

    Patient {
        uuid id PK
        uuid practice_id FK
        string first_name
        string last_name
        date date_of_birth
        string insurance_member_id
        string insurance_payer_id
    }

    Session {
        uuid id PK
        uuid practice_id FK
        uuid therapist_id FK
        uuid patient_id FK
        date session_date
        string cpt_code
        string icd10_code
        decimal fee
        decimal copay_collected
        string status
    }

    Claim {
        uuid id PK
        uuid practice_id FK
        uuid session_id FK
        string claim_number
        string payer_id
        decimal charge_amount
        decimal copay_amount
        string status
        jsonb validation_errors
    }

    Practice ||--o{ Therapist : "employs"
    Practice ||--o{ Patient : "treats"
    Practice ||--o{ Session : "owns"
    Practice ||--o{ Claim : "owns"
    Therapist ||--o{ Session : "conducts"
    Patient ||--o{ Session : "attends"
    Session ||--o| Claim : "generates"
            </div>
        </div>

        <div class="legend">
            <div class="legend-card">
                <h3>Practice (Tenant)</h3>
                <ul>
                    <li>id <span class="key-badge pk">PK</span></li>
                    <li>name</li>
                    <li>npi (National Provider Identifier)</li>
                    <li>tax_id</li>
                    <li>address, phone, email</li>
                    <li>created_at, updated_at</li>
                </ul>
            </div>
            <div class="legend-card">
                <h3>Therapist (Provider)</h3>
                <ul>
                    <li>id <span class="key-badge pk">PK</span></li>
                    <li>practice_id <span class="key-badge fk">FK</span> <span class="key-badge idx">IDX</span></li>
                    <li>first_name, last_name</li>
                    <li>npi (Individual NPI)</li>
                    <li>license_number, license_state</li>
                    <li>is_active</li>
                </ul>
            </div>
            <div class="legend-card">
                <h3>Patient</h3>
                <ul>
                    <li>id <span class="key-badge pk">PK</span></li>
                    <li>practice_id <span class="key-badge fk">FK</span> <span class="key-badge idx">IDX</span></li>
                    <li>first_name, last_name, dob, gender</li>
                    <li>insurance_member_id</li>
                    <li>insurance_payer_id</li>
                    <li>contact info (address, phone, email)</li>
                </ul>
            </div>
            <div class="legend-card">
                <h3>Session (Appointment)</h3>
                <ul>
                    <li>id <span class="key-badge pk">PK</span></li>
                    <li>practice_id <span class="key-badge fk">FK</span> <span class="key-badge idx">IDX</span></li>
                    <li>therapist_id <span class="key-badge fk">FK</span></li>
                    <li>patient_id <span class="key-badge fk">FK</span></li>
                    <li>session_date, start_time, end_time</li>
                    <li>cpt_code, icd10_code</li>
                    <li>fee, copay_collected</li>
                    <li>status (scheduled|completed|cancelled)</li>
                </ul>
            </div>
            <div class="legend-card">
                <h3>Claim</h3>
                <ul>
                    <li>id <span class="key-badge pk">PK</span></li>
                    <li>practice_id <span class="key-badge fk">FK</span> <span class="key-badge idx">IDX</span></li>
                    <li>session_id <span class="key-badge fk">FK</span></li>
                    <li>claim_number <span class="key-badge idx">UNIQUE</span></li>
                    <li>payer_id, service_date</li>
                    <li>cpt_code, icd10_code</li>
                    <li>charge_amount, copay_amount, paid_amount</li>
                    <li>status (draft|ready|submitted|accepted|rejected|paid)</li>
                    <li>validation_errors (JSONB)</li>
                </ul>
            </div>
        </div>

        <div class="relationships">
            <h2>Key Relationships</h2>
            <div class="rel-grid">
                <div class="rel-item"><code>Practice → Therapist</code> One-to-Many (a practice employs multiple therapists)</div>
                <div class="rel-item"><code>Practice → Patient</code> One-to-Many (a practice has multiple patients)</div>
                <div class="rel-item"><code>Practice → Session</code> One-to-Many (tenant isolation at session level)</div>
                <div class="rel-item"><code>Practice → Claim</code> One-to-Many (tenant isolation at claim level)</div>
                <div class="rel-item"><code>Therapist → Session</code> One-to-Many (a therapist conducts multiple sessions)</div>
                <div class="rel-item"><code>Patient → Session</code> One-to-Many (a patient attends multiple sessions)</div>
                <div class="rel-item"><code>Session → Claim</code> One-to-One (each session generates one claim)</div>
            </div>
        </div>

        <div class="notes">
            <h2>Design Notes</h2>
            <ul>
                <li><strong>Multi-Tenancy:</strong> Every table includes <code>practice_id</code> as a foreign key, enabling row-level tenant isolation. All queries should filter by practice_id.</li>
                <li><strong>Indexes:</strong> Composite indexes on <code>(practice_id, created_at)</code> for efficient tenant-scoped queries. Index on <code>claim_number</code> for lookups.</li>
                <li><strong>Claim Status Flow:</strong> draft → ready → submitted → accepted/rejected → paid</li>
                <li><strong>HIPAA Consideration:</strong> PHI fields (patient name, DOB, insurance IDs) should be encrypted at rest. Audit logging recommended.</li>
                <li><strong>837P Mapping:</strong> The Claim table structure maps to key 837P loops (2000A Billing Provider, 2000B Subscriber, 2300 Claim Info, 2400 Service Line)</li>
            </ul>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            er: {
                diagramPadding: 20,
                layoutDirection: 'TB',
                minEntityWidth: 100,
                minEntityHeight: 75,
                entityPadding: 15,
                useMaxWidth: true
            }
        });
    </script>
</body>
</html>
